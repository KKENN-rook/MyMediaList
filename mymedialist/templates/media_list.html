{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<h1>{{ title }}</h1>

<!-- Controls above the table -->
<div class="list-controls">
    <button id="addEntryBtn">Add Entry</button>

    <div class="sort-menu">
        <label for="sortSelect">Sort by:</label>
        <select id="sortSelect">
            <option value="title">Title (A-Z)</option>
            <option value="rating">Rating (High -> Low)</option>
        </select>
    </div>
</div>

<!-- Tabs for filtering by status -->
<div class="tabs">
    {% for status in ["All", "Completed", "In Progress", "Planned", "Dropped"] %}
    <button class="tab {% if loop.first %}active{% endif %}" data-status="{{ status }}">
        {{ status }}
    </button>
    {% endfor %}
</div>

<!-- Table -->
<table class="media-table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Rating</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in entries %}
        <tr data-status="{{ entry.status }}">
            <td class="title-cell">
                <span class="title-text">{{ entry.media.title }}</span>
                <button class="edit-btn" data-entry-id="{{ entry.id }}"
                    data-title="{{ entry.media.title }}"
                    data-rating="{{ entry.rating if entry.rating is not none else '' }}"
                    data-status="{{ entry.status }}" data-notes="{{ entry.notes or '' }}"
                    data-progress="{{ entry.progress_value if entry.progress_value is not none else '' }}">
                    Edit
                </button>
            </td>
            <td>
                {% if entry.rating is not none %}
                {{ entry.rating }}
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Entry Modal  -->
<div id="entryModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Add New Entry</h2>
        <p class="privacy-note">*Your list is private by default.</p>
        <form id="entryForm" method="POST"
            action="{{ url_for('lists.add_entry', category=category) }}">

            <!-- Hidden field to get the entry_id-->
            <input type="hidden" name="entry_id" id="entryId">

            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div>
                <label for="rating">Rating (1-10):</label>
                <select id="rating" name="rating">
                    <!-- optional dash for unrated -->
                    <option value="">-</option>
                    <!-- 1 through 10 rating -->
                    {% for i in range(1, 11) %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Planned">Planned</option>
                    <option value="Dropped">Dropped</option>
                </select>
            </div>

            <div>
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>

            <div class="form-buttons">
                <button type="submit" id="saveBtn">Add Entry</button>
                <button type="button" id="deleteBtn" class="delete-btn">Delete Entry</button>
        </form>
    </div>
</div>

<!-- JS -->
<script>
    // Tab switching logic 
    const tabs = document.querySelectorAll(".tab");
    const rows = document.querySelectorAll("tbody tr");

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            const status = tab.dataset.status;
            rows.forEach(r => {
                r.style.display = (status === "All" || r.dataset.status === status) ? "" : "none";
            });
        });
    });

    // ------------ ADD/EDIT/DELETE MODAL ------------ 
    const modal = document.getElementById("entryModal");
    const modalTitle = document.getElementById("modalTitle");
    const entryForm = document.getElementById("entryForm");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    // Uses entry_id via url to edit/delete 
    const editBase = "{{ url_for('lists.edit_entry', category=category, entry_id=0) }}".replace(/0$/, "");
    const deleteBase = "{{ url_for('lists.delete_entry', category=category, entry_id=0) }}".replace(/0$/, "");

    // Add mode
    document.getElementById("addEntryBtn").addEventListener("click", () => {
        modalTitle.textContent = "Add New Entry";
        entryForm.action = "{{ url_for('lists.add_entry', category=category) }}";
        saveBtn.textContent = "Add Entry";
        deleteBtn.style.display = "none";
        entryForm.reset();
        modal.style.display = "block";
    });

    // Edit mode
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            modalTitle.textContent = "Edit Entry";
            saveBtn.textContent = "Save Changes";
            deleteBtn.style.display = "inline-block";


            const entryId = btn.dataset.entryId;
            entryForm.action = editBase + entryId;

            // Writes the entry ID into the hidden form input  
            document.getElementById("entryId").value = entryId;

            // Fill fields 
            document.getElementById("title").value = btn.dataset.title;
            document.getElementById("rating").value = btn.dataset.rating || "";
            document.getElementById("status").value = btn.dataset.status;
            document.getElementById("notes").value = btn.dataset.notes || "";
            // document.getElementById("progress_value").value = btn.dataset.progress || "";

            modal.style.display = "block";
        });
    });

    // Close modal
    document.querySelectorAll(".close").forEach(el => el.addEventListener("click", () => {
        modal.style.display = "none";
    }));

    // Confirm delete
    deleteBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to delete this entry?")) {
            const entryId = document.getElementById("entryId").value;
            entryForm.action = deleteBase + entryId;
            entryForm.submit();
        }
    });

    // Close on click outside modal
    window.addEventListener("click", e => {
        if (e.target === modal) modal.style.display = "none";
    });


    // ------------ SORTING LOGIC ------------ 
    const sortSelect = document.getElementById("sortSelect");
    const tbody = document.querySelector(".media-table tbody");

    sortSelect.addEventListener("change", () => {
        const option = sortSelect.value;
        const rows = Array.from(tbody.querySelectorAll("tr"));

        let sorted;
        if (option === "title") {
            sorted = rows.sort((a, b) => {
                const titleA = a.querySelector(".title-text").textContent.trim().toLowerCase();
                const titleB = b.querySelector(".title-text").textContent.trim().toLowerCase();
                return titleA.localeCompare(titleB);
            });
        } else if (option === "rating") {
            sorted = rows.sort((a, b) => {
                const ratingA = parseFloat(a.children[1].textContent) || 0;
                const ratingB = parseFloat(b.children[1].textContent) || 0;
                return ratingB - ratingA; // high â†’ low
            });
        }

        tbody.innerHTML = "";
        sorted.forEach(row => tbody.appendChild(row));
    });
</script>

{% endblock %}